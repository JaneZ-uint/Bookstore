# Bookstore-2024 总体设计文档
### By 朱奕涵 (janez)

## 目录
* [程序功能概述](#程序功能概述)
* [代码文件结构](#代码文件结构)
* [数据库设计](#数据库设计)
* [类、结构体设计](#类、结构体设计)

## 程序功能概述
#### **账户系统 UserSystem** 
- 用于实现账户创建及登录 
- 特性：最低权限要求为游客{0}
#### **图书(用户)系统 BookUserSystem**
- 用于实现检索图书、购买图书、选择图书
- 特性：不会改变图书信息 最低权限要求为顾客{1}
#### **图书(管理员)系统 BookManagerSystem**
- 用于实现图书进货、修改图书信息
- 特性：会改变图书信息 最低权限要求为员工{3}
#### **图书(店长)系统 BookOwnerSystem**
- 用于财务记录查询
- 用于生成财务记录报告指令 按顺序先输出所有采购信息，再输出所有销售信息，最后输出当前盈利情况
- 用于生成全体员工工作情况报告指令 按顺序输出(操作人员 操作类型)
- 用于生成日志(账户创建 图书购买记录 图书信息查询记录 员工工作情况报告)


## 代码文件结构
### User.h /User.cpp
```
class Book;
class BookInfo;
class Blog;

//记录用户信息
class UserInfo {
    friend class User;
    friend class Block<500 , 71 , UserInfo>;
    friend class Book;
    friend class BookInfo;
    friend class Finance;
    friend class Blog;
private:
    char UserID[71] = {'\0'}; //ID
    char UserName[71] = {'\0'}; //用户名
    char Password[71] = {'\0'};  //密码
    int level  = 0;  //权限等级
    bool selected = false; //当前账户有没有选择图书

public:
    char selectedISBN[71] = {'\0'};
    //选择的是什么selectedISBN 如果每选那么默认为{‘\0}
    UserInfo() = default;
    //构造函数
    UserInfo(const char* User_ID ,const char* User_name , const char* password , int LEVEL ) {
        std::strncpy(UserID , User_ID , 71);
        std::strncpy(UserName , User_name , 71);
        std::strncpy(Password , password , 71);
        level = LEVEL;
    }
    //重载运算符

    bool operator==(const UserInfo &) const;

    bool operator<(const UserInfo &)const;

    bool operator<=(const UserInfo &)const;

    bool operator>(const UserInfo &)const;

    bool operator>=(const UserInfo& )const;
};


//实现账户的多个操作
class User {
    friend class Blog;
    friend class Book;
    friend class Finance;
private:
    int currentlevel = 0; // 当前用户权限
    Block<500 , 71 , UserInfo> UserBlock; //存储当前系统内所有账户信息
    std::unordered_map<std::string , int> Log_Map ; //用于存储当前用户处于登录状态的号有几个

public:

    //维护登录栈
    //为了在logout操作中得到最后一次su的账户
    std::vector<UserInfo> LogStack;
    User();
    ~User();

    //涉及到账户有关操作的成员函数声明
    //登录账户
    void su(const char* User_ID , const char* password , Blog& blog);

    //注销账户
    void logout(Book& book , Blog& blog );

    //注册账户
    void Register(const char* User_ID , const char* password , const char* user_name , Blog& blog);

    //修改密码
    void RevisePassword(const char* User_ID , const char* currentPassword, const char* newPassword , Blog& blog , const char* command);

    //创建账户
    void UserAdd(const char* User_ID, const char* password , const int LEVEL , const char* user_name , Blog& blog, const char* command);

    //删除账户
    void Delete(const char* User_ID , Blog& blog);

    //退出系统
    void Eliminate();

};
```
### Book.h /Book.cpp
```
class Blog;
class User;
class Finance;

//存储所有图书相关信息
class BookInfo {
    friend class Book;
    friend class User;
    friend class Block<500 , 71 , BookInfo>;
    friend class FinanceInfo;
private:
    char ISBN[71] = {'\0'};
    char BookName[71] = {'\0'};
    char Author[71] = {'\0'};
    char KeyWord[71] = {'\0'};
    int Quantity = 0;
    double Price = 0; //售价
    double Importprice = 0; // 进价
    bool hasindex = false; //判断当前图书是否具有关键字
public:
    BookInfo() = default;
    BookInfo(const char* isbn) {
        strcpy(ISBN, isbn);
    }

    //重载运算符

    bool operator==(const BookInfo &) const;

    bool operator<(const BookInfo &)const;

    bool operator<=(const BookInfo &)const;

    bool operator>(const BookInfo &)const;

    bool operator>=(const BookInfo& )const;
};


//Book系统中最重要最核心的类
class Book {
    friend class Finance;
    friend class User;
    friend class Blog;
private:
    //表面上看映射到BookInfo 实际上直接映射的是 ISBN(好吧好像也不完全
    Block<500 , 71  ,BookInfo> Book_ISBN; //ISBN->ISBN映射
    Block<500 , 71 , BookInfo> Book_Name; //name->ISBN映射
    Block<500 , 71 , BookInfo> Book_Author; //Author->ISBN映射
    Block<500 , 71 , BookInfo> Book_keyword;  //keyword->ISBN映射

public:
    //当前选中的图书的全部信息
    //根据登录栈中当前最后一个账户是否选择 选择了什么来决定
    //logout select 等操作时不断更新这个selected
    BookInfo selected;
    Book():Book_ISBN("ISBN1.txt", "ISBN2.txt"), Book_Name("name1.txt","name2.txt"),Book_Author("author1.txt","author2.txt"),Book_keyword("keyword1.txt","keyword2.txt") {}
    ~Book();

    //检索图书
    void showInfo(const char* isbn , const char* bookname , const char* Author, const char* singlekeyword,User& UserManage, Blog& blog);

    //special situation
    void showeverything(User& UserManage, Blog& blog );

    //购买图书
    void Shopping(const char* isbn , const int QUANT ,User& UserManage, Finance& money , Blog& blog);

    //选择图书
    void Select_Book(const char* isbn,User& UserManage, Blog& blog,const char* command);

    //分割多个关键词
    std::vector<std::string> SplitKeywords(const char* allkeyword);

    //修改图书信息
    void modify(const char* isbn , const char* bookname ,const char* Author, const char* all_keywords , double price ,User& UserManage, Blog& blog , const char* command);

    //图书进货
    void ImportBook(const int QUANT , double COST ,User& UserManage,Finance& money, Blog& blog , const char* command);
};

```
### Finance.h / Finance.cpp
```
class User;

//财务相关信息
class FinanceInfo {
    friend class Finance;
    friend class Book;
private:
    double price = 0.00; // 图书售价
    double cost = 0.00; //图书消费
    int QUANT = 0;  //数量
    bool state; // + or -
    char UserID[71] = {'\0'}; //进行操作的人员
    char ISBN[71] = {'\0'}; //被操作图书的isbn号
    double money; //交易总额
public:
    FinanceInfo():money(0.00) ,state(true){}
    explicit FinanceInfo(double Price, double Cost ,int QUANT , bool Status , const char* User_ID, const char* isbn,double money):price(Price),cost(Cost),QUANT(QUANT), state(Status),money(money) {
        strcpy(UserID , User_ID);
        strcpy(ISBN , isbn);
    }
};
//与财务相关操作
class Finance {
    friend class Book;
    friend class FinanceInfo;
private:
    //财务报告  直接写在文件里
    MemoryRiver<FinanceInfo , 1> FinanceReport;
public:
    Finance();
    ~Finance();

    //获得当前交易笔数总数
    int FinanceCount();

    //财务记录查询
    void ShowFinance(int count ,User& UserManage);

    //生成财务记录报告
    void ReportFinance(User& UserManage);
};
```
### Blog.h / Blog.cpp
```
class Information {
    friend class Blog;
private:
    char UserID[71] = {'\0'};
    char behave[100] = {'\0'};
    int level = 0;
    double cost = 0.00;
    bool state = true;

public:
    Information() = default;
    explicit Information(const char* User_ID , const char* Behave , int Level ):level(Level) {
        strcpy(UserID, User_ID);
        strcpy(behave , Behave);
    }

    explicit Information(const char* User_ID , const char* Behave , int Level ,double COST , bool status):level(Level),cost(COST),state(status) {
        strcpy(UserID, User_ID);
        strcpy(behave , Behave);
    }
};


class Blog {
private:
    MemoryRiver<Information , 1> blog;
public:
    Blog();

    //记录博客
    void WriteBlog(Information& info);

    //读取员工工作报告
    void ReadWorker(User& UserManage);

    //读取全部信息
    void ReadAll(User& UserManage);
};
```
### Tokenscanner.h / Tokenscanner.cpp
```
class Tokenscanner {
//private:
    //std::string command;
    //std::vector<std::string> Tokens;
public:

    static void TokenSeparator(const std::string input, std::vector<std::string> &result);

    static int StringToIntegerQuant(const std::string& s);

    static int StringToIntegerCount(const std::string& s);

    static double StringToDouble(const std::string& s);

    static void checkIDPassword(const std::string& s);

    static void checkUsername(const std::string& s);

    static void checkPrivilege(const std::string& s);

    static void checkISBN(const std::string& s);

    static void checkBooknameAuthor(const std::string& s);
    
    static void checkKeyWordSingle(const std::string& s);

    static std::string cutShow(const std::string& s);

    static std::string cutModify(const std::string& s);

    static void checkKeywordAll(const std::string& s);
};
```

## 数据库设计
#### 用户信息储存
- UserID->UserInfo (块状链表)
#### 图书信息储存
- ISBN->BookInfo (块状链表) 
- name->BookInfo (块状链表)
- author->BookInfo (块状链表)
- keyword->BookInfo (块状链表)
#### 财务信息储存 
- finance_file 文件存储
#### 日志信息储存
- blog-file 文件存储



## 类、结构体设计
- Tokenscanner类 进行指令切片
- Book类 存储所有书籍相关信息并实现操作
  Book & BookInfo 
- User类 存储所有用户相关信息并实现操作
  User & UserInfo 
- Finance类 存储财务相关信息并实现操作
- Blog类 存储日志内容并实现操作
- Error类 抛出异常
- Block类 块状链表实现文件存储(文件存储测试类模板化)
- MemoryRiver类 文件读写

## 其他补充说明